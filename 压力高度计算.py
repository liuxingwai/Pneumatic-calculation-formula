# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file '压力高度计算.ui'
#
# Created by: PyQt5 UI code generator 5.15.2
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QMainWindow,QMessageBox
import numpy as np
import matplotlib.pyplot as plt
from PyQt5.QtGui import *
import sqlite3
import datetime
from sqlite3 import Error

#连接数据库
def sql_connection():
    try:
        # con = sqlite3.connect("压力高度计算数据库.db")
        con = sqlite3.connect("公式集合数据库.db")
        return con
    except Error:
        print(Error)
#创建表
def sql_table(con):
    try:
        # 创建游标
        cursor = con.cursor()
        cursor.execute("create table 压力高度 (日期,海拔高度,低压值,海拔0m的温度,低压温度)")
        # 提交事务
        con.commit()
    except Error:
        print(Error)
con = sql_connection()
sql_table(con)


class Ui_yaligaodu(QMainWindow):
    def setupUi(self, yaligaodu):
        yaligaodu.setObjectName("yaligaodu")
        yaligaodu.resize(760, 400)
        yaligaodu.setMaximumSize(QtCore.QSize(760, 400))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(14)
        yaligaodu.setFont(font)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap(":/PNG/chengliang.png"), QtGui.QIcon.Normal, QtGui.QIcon.Off)
        yaligaodu.setWindowIcon(icon)
        yaligaodu.setStyleSheet("background-color: rgb(255, 255, 255);")
        # self.pushButton = QtWidgets.QPushButton(yaligaodu)
        # self.pushButton.setGeometry(QtCore.QRect(330, 340, 80, 40))
        # font = QtGui.QFont()
        # font.setFamily("楷体")
        # font.setPointSize(20)
        # self.pushButton.setFont(font)
        # self.pushButton.setStyleSheet("background-color: rgb(87, 168, 255);")
        # self.pushButton.setObjectName("pushButton")
        self.label_2 = QtWidgets.QLabel(yaligaodu)
        self.label_2.setGeometry(QtCore.QRect(320, 110, 111, 30))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.label_2.setFont(font)
        self.label_2.setAlignment(QtCore.Qt.AlignCenter)
        self.label_2.setObjectName("label_2")
        self.lineEdit_2 = QtWidgets.QLineEdit(yaligaodu)
        self.lineEdit_2.setEnabled(True)
        self.lineEdit_2.setGeometry(QtCore.QRect(437, 100, 300, 50))
        self.lineEdit_2.setMinimumSize(QtCore.QSize(50, 50))
        self.lineEdit_2.setMaximumSize(QtCore.QSize(500, 50))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.lineEdit_2.setFont(font)
        self.lineEdit_2.setObjectName("lineEdit_2")
        self.label = QtWidgets.QLabel(yaligaodu)
        self.label.setGeometry(QtCore.QRect(20, 110, 60, 30))
        self.label.setMaximumSize(QtCore.QSize(80, 50))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.label.setFont(font)
        self.label.setAlignment(QtCore.Qt.AlignCenter)
        self.label.setObjectName("label")
        self.lineEdit = QtWidgets.QLineEdit(yaligaodu)
        self.lineEdit.setGeometry(QtCore.QRect(90, 100, 200, 50))
        self.lineEdit.setMinimumSize(QtCore.QSize(0, 0))
        self.lineEdit.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.lineEdit.setFont(font)
        self.lineEdit.setObjectName("lineEdit")
        self.label_3 = QtWidgets.QLabel(yaligaodu)
        self.label_3.setEnabled(True)
        self.label_3.setGeometry(QtCore.QRect(40, 20, 691, 61))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(18)
        self.label_3.setFont(font)
        self.label_3.setStyleSheet("")
        self.label_3.setAlignment(QtCore.Qt.AlignCenter)
        self.label_3.setObjectName("label_3")
        self.label_4 = QtWidgets.QLabel(yaligaodu)
        self.label_4.setEnabled(True)
        self.label_4.setGeometry(QtCore.QRect(40, 180, 691, 61))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(18)
        self.label_4.setFont(font)
        self.label_4.setStyleSheet("")
        self.label_4.setAlignment(QtCore.Qt.AlignCenter)
        self.label_4.setObjectName("label_4")
        self.lineEdit_3 = QtWidgets.QLineEdit(yaligaodu)
        self.lineEdit_3.setEnabled(True)
        self.lineEdit_3.setGeometry(QtCore.QRect(440, 260, 300, 50))
        self.lineEdit_3.setMinimumSize(QtCore.QSize(50, 50))
        self.lineEdit_3.setMaximumSize(QtCore.QSize(500, 50))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.lineEdit_3.setFont(font)
        self.lineEdit_3.setObjectName("lineEdit_3")
        self.label_5 = QtWidgets.QLabel(yaligaodu)
        self.label_5.setGeometry(QtCore.QRect(20, 270, 80, 30))
        self.label_5.setMaximumSize(QtCore.QSize(80, 50))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.label_5.setFont(font)
        self.label_5.setWhatsThis("")
        self.label_5.setAlignment(QtCore.Qt.AlignCenter)
        self.label_5.setObjectName("label_5")
        self.label_6 = QtWidgets.QLabel(yaligaodu)
        self.label_6.setGeometry(QtCore.QRect(323, 270, 111, 30))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.label_6.setFont(font)
        self.label_6.setAlignment(QtCore.Qt.AlignCenter)
        self.label_6.setObjectName("label_6")
        self.lineEdit_4 = QtWidgets.QLineEdit(yaligaodu)
        self.lineEdit_4.setGeometry(QtCore.QRect(100, 260, 200, 50))
        self.lineEdit_4.setMinimumSize(QtCore.QSize(0, 0))
        self.lineEdit_4.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setFamily("楷体")
        font.setPointSize(20)
        self.lineEdit_4.setFont(font)
        self.lineEdit_4.setObjectName("lineEdit_4")

        self.retranslateUi(yaligaodu)
        QtCore.QMetaObject.connectSlotsByName(yaligaodu)

        #设置提示语和清理按钮
        self.lineEdit.setPlaceholderText("海拔高度")  # 文本框提示语
        self.lineEdit.setClearButtonEnabled(True)
        self.lineEdit_4.setPlaceholderText("海拔0m的温度")  # 文本框提示语
        self.lineEdit_4.setClearButtonEnabled(True)

        #设置槽信号
        self.lineEdit.editingFinished.connect(self.yaligaodu)
        self.lineEdit_4.editingFinished.connect(self.wendujisuan)

        # 只允许输入数字
        self.lineEdit.setValidator(QDoubleValidator())
        self.lineEdit_2.setValidator(QDoubleValidator())
        self.lineEdit_3.setValidator(QDoubleValidator())
        self.lineEdit_4.setValidator(QDoubleValidator())

        self.lineEdit_4.setText('25')
        self.lineEdit_4.setStyleSheet("background-color: rgb(85, 255, 255);")
        self.lineEdit.setStyleSheet("background-color: rgb(85, 255, 255);")

    def retranslateUi(self, yaligaodu):
        _translate = QtCore.QCoreApplication.translate
        yaligaodu.setWindowTitle(_translate("yaligaodu", "海拔高度 温度 压力计算V1.1 By ChengLiang"))
        # self.pushButton.setText(_translate("yaligaodu", "计算"))
        self.label_2.setText(_translate("yaligaodu", "P（KPa）"))
        self.label.setText(_translate("yaligaodu", "H(m)"))
        self.label_3.setText(_translate("yaligaodu", "P=101.3*(1−0.0255*𝐻/1000*(6357/(6357+𝐻/1000)))^5.256"))
        self.label_4.setText(_translate("yaligaodu", "T=t-6*H/1000"))
        self.label_5.setText(_translate("yaligaodu", "t(℃)"))
        self.label_6.setText(_translate("yaligaodu", "T(℃)"))


    #创建计算
    def yaligaodu(self):
        global H,P,t,T
        H = float(self.lineEdit.text())
        t = self.lineEdit_4.text()
        if H<0:
            self.lineEdit.clear()
            QMessageBox.information(None, "使用提示", "高度输入错误，请检查后重新输入！", QMessageBox.Ok)
        elif t==None or t=="":
            QMessageBox.information(None, "使用提示", "请输入海拔0m的温度！", QMessageBox.Ok)
        else:
            P = 101.3 * np.power((1 - 0.0255 * H/ 1000 * (6357 / (6357 + H / 1000))), 5.256)
            T = float(t) - 6 * H / 1000
            self.lineEdit_2.setText(str(P))
            self.lineEdit_3.setText(str(T))
            self.P_H_curve()
            self.shuju()
    def wendujisuan(self):
        global  H,P,t,T
        H = self.lineEdit.text()
        if  H==None or H=="":
            QMessageBox.information(None, "使用提示", "请输入高度值！", QMessageBox.Ok)
        else:
            t = float(self.lineEdit_4.text())
            T = t - 6 * float(H) / 1000
            P = 101.3 * np.power((1 - 0.0255 * float(H) / 1000 * (6357 / (6357 + float(H) / 1000))), 5.256)
            self.lineEdit_3.setText(str(T))
            self.lineEdit_2.setText(str(P))
            self.shuju()

    def datetime(self):
        global now_time
        now_time = datetime.datetime.now().strftime("%Y.%m.%d %H:%M:%S")

    def shuju(self):
        self.datetime()
        def sql_insert(con, data):
            cursor = con.cursor()
            cursor.execute("insert into 压力高度 (日期,海拔高度,低压值,海拔0m的温度,低压温度) values(?,?,?,?,?)", data)
            con.commit()
        data = ( now_time,H,P,t,T)
        sql_insert(con, data)

    def P_H_curve(self):
        # 绘制曲线
        plt.clf()
        x = np.arange(0, float(H), 0.1)
        y = 101.3 * np.power((1 - 0.0255 * x / 1000 * (6357 / (6357 + x / 1000))), 5.256)
        plt.plot(x, y, label="P-H curve")
        plt.xlabel("H(m)")
        plt.ylabel("P(KPa)")
        plt.title("P-H curve")
        plt.show()

import img_rc

import sys
if __name__ == '__main__':
    app = QtWidgets.QApplication(sys.argv)
    Mainwidow = QtWidgets.QMainWindow()  # 创建窗体对象
    ui = Ui_yaligaodu()  # 创建QT设计的窗体
    ui.setupUi(Mainwidow)  # 初始化设置
    Mainwidow.show()  # 显示窗体
    sys.exit(app.exec_())  # 程序关闭时退出进程
